---
const { caption, description, cssClass, index, site, src, total, type } = Astro.props

// A random string with the syntax '[a-z][0-9]{3}-index-total'
const key = Math.random().toString(36).slice(2, 6) + '-' + index + '/' + total
---

<a-work class={cssClass}>
  <div class="a__inner">
    <a href={site} target="_blank">
      {type === 'youtube' ? (
        <iframe
          data-src={src}
          class="a__video js-video"
          width="1082"
          height="636"
          frameborder="0"
          allow="autoplay; encrypted-media"
          style="pointer-events: none;"
        ></iframe>
      ) : type === 'image' ? (
        <img
          src={src}
          class="a__video js-video"
          width="1082"
          height="636"
          alt={caption}
          loading="lazy"
        />
      ) : (
        <video
          data-src={src}
          class="a__video js-video"
          loop
          muted
          playsinline
          width="1082"
          height="636"
        >
        </video>
      )}

      <div class="a__caption">
        <div class="a__caption__text">
          {caption}
        </div><!-- .a__caption__text -->

        <div class="a__caption__key">
          #{key}
        </div><!-- .a__caption__key -->
      </div><!-- .a__caption -->

      {description && (
        <div class="a__description">
          {description}
        </div>
      )}
    </a>
  </div><!-- .a__inner -->
</a-work>

<script>
  class AWork extends HTMLElement {
    static observedAttributes = ['progress']

    link: HTMLAnchorElement
    video: HTMLVideoElement | HTMLIFrameElement

    isPlaying: boolean

    /**
     * Init
     */
    connectedCallback() {
      // Elements
      this.video = this.querySelector('.js-video')
      this.link = this.querySelector('a')

      // Properties
      this.isPlaying = false

      // Events
      this.link.addEventListener('click', this.onClick.bind(this))
    }

    /**
     * Attribute changed
     */
    attributeChangedCallback(name, oldValue, newValue) {
      if (name === 'progress') {
        this.style.setProperty('--progress', newValue)

        if (newValue === '1' || newValue === '-1') {
          if (this.isPlaying) {
            this.outView()
          }
        } else {
          if (!this.isPlaying) {
            this.inView()
          }
        }
      }
    }

    /**
     * Gets in view
     */
    inView() {
      if (this.video) {
        if (this.video.tagName === 'VIDEO') {
          (this.video as HTMLVideoElement).play()
        } else if (this.video.tagName === 'IFRAME') {
           const iframe = this.video as HTMLIFrameElement
           if (!iframe.src) {
             iframe.src = iframe.dataset.src || ''
           }
        }
      }
      this.isPlaying = true

      this.classList.add('is-inview')
    }

    /**
     * Gets out view
     */
    outView() {
      if (this.video) {
        if (this.video.tagName === 'VIDEO') {
          (this.video as HTMLVideoElement).pause()
        } 
        // Do not clear src for iframes to prevent reloading/flashing
      }
      this.isPlaying = false

      this.classList.remove('is-inview')
    }

    /**
     * On click
     */
    onClick(event: MouseEvent) {
      if (this.link.href.includes('#') && !this.link.href.includes('youtube')) {
        event.preventDefault()
        return false
      }
    }
  }

  customElements.define('a-work', AWork)
</script>

<style lang="scss">
  a-work {
    position: relative;
    top: 0;
    left: 0;

    display: block;
    margin: 0;
    padding: 0.5rem 0.5rem 0;

    background: color(secondary);
    content-visibility: hidden;

    transform-style: preserve-3d;

    will-change: transform;

    @include mq(phone) {
      padding: 0.25rem;
    }

    a {
      display: block;

      text-decoration: none;
    }

    .a__inner {
      position: relative;
      display: block;
      margin: 0;
      padding: 0;
      overflow: hidden; /* Clip zoomed video */
    }

    .a__video {
      display: block;

      width: 100%;
      max-width: 50vw;
      height: auto;
      aspect-ratio: 16 / 9;
      object-fit: cover;
      /* transform: scale(1.35);  Variable moved to specific types */

      @include mq(phone) {
        max-width: 80vw;
      }
    }

    iframe.a__video {
      max-width: 60vw;
      /* transform: scale(1.35); Removed to show full video content */

      @include mq(phone) {
        max-width: 90vw;
      }
    }

    img.a__video {
      max-width: 40vw;

      @include mq(phone) {
        max-width: 70vw;
      }
    }

    .a__caption {
      @include flex(row, center, space-between);

      padding: 0.5rem 0.5rem;

      color: color(primary);
      font: 700 11px / 1 font-family(fraktion);
      letter-spacing: 0.15em;
      text-align: right;
      text-transform: uppercase;

      @include mq(phone) {
        display: none;
      }
    }

    .a__description {
      padding: 0 1rem 1rem;
      color: color(white);
      font-size: 0.9rem;
      line-height: 1.4;
      white-space: pre-wrap;
      font-family: sans-serif;
      opacity: 0.8;
      max-width: 50vw;
    }

    &.is-inview {
      content-visibility: visible;
    }
  }
</style>
